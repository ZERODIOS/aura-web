<script>
// ===== CONFIGURACIÃ“N API =====
const API_URL = "https://api-aura-204e.onrender.com/api";
const DEVICE_ID = "ESP32_AURA_01";

// ===== ENDPOINTS =====
const ENDPOINTS = {
    status: "/status",
    modo: "/modo",
    ventiladorOn: "/ventilador/on",
    ventiladorOff: "/ventilador/off",
    focoOn: "/foco/on",
    focoOff: "/foco/off",
    focoIntensidad: "/foco/intensidad",
    bocinaPlay: "/bocina/play",
    bocinaStop: "/bocina/stop",
    bocinaVolumen: "/bocina/volumen"
};

async function verificarConexion() {
    const status = document.getElementById('connectionStatus');
    const text = document.getElementById('connectionText');
    
    try {
        const response = await fetch(`${API_URL}${ENDPOINTS.status}?dispositivo_id=${DEVICE_ID}`);
        
        if (response.ok) {
            const data = await response.json();
            status.classList.add('connected');
            text.textContent = `Conectado - Modo: ${data.modo_automatico ? 'AutomÃ¡tico' : 'Manual'}`;
            
            document.getElementById('modoOperacion').checked = data.modo_automatico;
            actualizarModoUI(data.modo_automatico);
            
            document.getElementById('switchVentilador').checked = data.ventilador_encendido;
            document.getElementById('estadoVentilador').textContent = data.ventilador_encendido ? 'Encendido' : 'Apagado';
            
            document.getElementById('switchFoco').checked = data.foco_encendido;
            document.getElementById('estadoFoco').textContent = data.foco_encendido ? 'Encendido' : 'Apagado';
            document.getElementById('rangoFoco').value = data.foco_intensidad;
            document.getElementById('valorFoco').textContent = data.foco_intensidad + '%';
        } else {
            throw new Error('No conectado');
        }
    } catch (error) {
        status.classList.remove('connected');
        text.textContent = `Sin conexiÃ³n - ESP32 apagado o desconectado`;
        console.error('Error de conexiÃ³n:', error);
    }
}

function actualizarModoUI(esAutomatico) {
    const cardFoco = document.getElementById('cardFoco');
    const cardVentilador = document.getElementById('cardVentilador');
    
    if (esAutomatico) {
        cardFoco.classList.add('disabled');
        cardVentilador.classList.add('disabled');
    } else {
        cardFoco.classList.remove('disabled');
        cardVentilador.classList.remove('disabled');
    }
}

// ===== MODO DE OPERACIÃ“N =====
document.getElementById('modoOperacion').addEventListener('change', async function() {
    const automatico = this.checked;
    
    try {
        const response = await fetch(`${API_URL}${ENDPOINTS.modo}?automatico=${automatico}&dispositivo_id=${DEVICE_ID}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            actualizarModoUI(automatico);
            console.log(automatico ? 'ðŸ”„ Modo AutomÃ¡tico' : 'ðŸ”„ Modo Manual');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar modo');
        this.checked = !this.checked;
    }
});

// ===== VENTILADOR =====
document.getElementById('switchVentilador').addEventListener('change', async function() {
    if (document.getElementById('modoOperacion').checked) {
        this.checked = !this.checked;
        alert('Cambia a modo Manual para controlar el ventilador');
        return;
    }
    
    const endpoint = this.checked ? ENDPOINTS.ventiladorOn : ENDPOINTS.ventiladorOff;
    
    try {
        const response = await fetch(`${API_URL}${endpoint}?dispositivo_id=${DEVICE_ID}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            document.getElementById('estadoVentilador').textContent = this.checked ? 'Encendido' : 'Apagado';
            console.log(this.checked ? 'ðŸŒ€ Ventilador ON' : 'ðŸŒ€ Ventilador OFF');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al controlar ventilador');
        this.checked = !this.checked;
    }
});

// ===== FOCO =====
document.getElementById('switchFoco').addEventListener('change', async function() {
    if (document.getElementById('modoOperacion').checked) {
        this.checked = !this.checked;
        alert('Cambia a modo Manual para controlar el foco');
        return;
    }
    
    const endpoint = this.checked ? ENDPOINTS.focoOn : ENDPOINTS.focoOff;
    
    try {
        const response = await fetch(`${API_URL}${endpoint}?dispositivo_id=${DEVICE_ID}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            document.getElementById('estadoFoco').textContent = this.checked ? 'Encendido' : 'Apagado';
            console.log(this.checked ? 'ðŸ’¡ Foco ON' : 'ðŸ’¡ Foco OFF');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al controlar foco');
        this.checked = !this.checked;
    }
});

// ===== INTENSIDAD FOCO =====
const rangoFoco = document.getElementById('rangoFoco');
const valorFoco = document.getElementById('valorFoco');

rangoFoco.addEventListener('input', function() {
    valorFoco.textContent = this.value + '%';
});

rangoFoco.addEventListener('change', async function() {
    if (document.getElementById('modoOperacion').checked) {
        alert('Cambia a modo Manual para ajustar intensidad');
        return;
    }
    
    const intensidad = this.value;
    
    try {
        const response = await fetch(`${API_URL}${ENDPOINTS.focoIntensidad}?intensidad=${intensidad}&dispositivo_id=${DEVICE_ID}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            console.log(`ðŸ’¡ Intensidad: ${intensidad}%`);
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// ===== RUIDO BLANCO (BOCINA) =====
const switchSonido = document.getElementById('switchSonido');
const rangoSonido = document.getElementById('rangoSonido');

switchSonido.addEventListener('change', async function() {
    const endpoint = this.checked ? ENDPOINTS.bocinaPlay : ENDPOINTS.bocinaStop;
    
    try {
        const response = await fetch(`${API_URL}${endpoint}`, { method: 'POST' });
        
        if (response.ok) {
            document.getElementById('estadoSonido').textContent = this.checked ? 'Reproduciendo' : 'Apagado';
        }
    } catch (error) {
        console.error('Error:', error);
        this.checked = !this.checked;
    }
});

rangoSonido.addEventListener('input', function() {
    document.getElementById('valorSonido').textContent = this.value + '%';
});

rangoSonido.addEventListener('change', async function() {
    try {
        await fetch(`${API_URL}${ENDPOINTS.bocinaVolumen}?valor=${this.value}`, { method: 'POST' });
    } catch (error) {
        console.error('Error:', error);
    }
});

// ===== MODO OSCURO =====
(function () {
    const toggle = document.getElementById("toggleDark");
    const saved = localStorage.getItem('modo-oscuro');
    const isDark = saved === 'true';
    
    if (isDark) {
        document.body.classList.add('dark');
        toggle.classList.replace('bi-moon', 'bi-sun');
    }
    
    toggle.addEventListener('click', () => {
        const nowDark = document.body.classList.toggle('dark');
        localStorage.setItem('modo-oscuro', nowDark ? 'true' : 'false');
        toggle.classList.toggle('bi-moon');
        toggle.classList.toggle('bi-sun');
    });
})();

// ===== MENÃš =====
document.getElementById("btnMenu").addEventListener("click", () => {
    document.querySelector(".sidebar").classList.toggle("closed");
    document.querySelector(".main-content").classList.toggle("closed");
});

// ===== INICIALIZACIÃ“N =====
window.addEventListener('load', () => {
    verificarConexion();
    setInterval(verificarConexion, 10000);
});
</script>
